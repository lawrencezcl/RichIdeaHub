# V0.1（开发版）+ V0.2（测试版）功能需求与技术设计文档
## 一、V0.1（开发版）：基础框架搭建
### （一）功能需求文档（FRD）
#### 1. 核心目标
完成「基础技术框架搭建+核心数据存储+最小可用功能」，支持后续功能迭代，输出可跑通的开发环境。

#### 2. 功能模块（按角色划分）
##### 2.1 开发/管理员角色（核心）
| 功能模块       | 具体需求点                                                                 | 验收标准                                                                 |
|----------------|----------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 数据库初始化   | 1. 创建Neon PostgreSQL核心表（users/accounts/sessions/cases/reviews）；<br>2. 配置Neon每日自动备份（保留7天）；<br>3. 开通Neon只读节点（优化查询性能） | 1. 所有表结构创建成功，字段无缺失；<br>2. Neon控制台显示“备份任务正常”；<br>3. 只读节点连接测试成功（查询延迟≤200ms） |
| NextAuth登录集成 | 1. 实现2种登录方式：Google OAuth、邮箱密码登录；<br>2. 支持“邮箱验证”（Resend发送验证码）；<br>3. 会话有效期默认7天，支持手动退出 | 1. Google登录跳转正常，成功后同步用户信息到users表；<br>2. 邮箱注册后5分钟内收到验证码，验证后email_verified更新；<br>3. 退出登录后会话token清除，无法访问需登录页面 |
| Deepseek API连通 | 1. 实现“案例信息提取”接口（输入Reddit/IndieHackers帖子内容，输出标题/收益/时间）；<br>2. 实现“Embeddings向量生成”接口（输入文本，输出768维向量） | 1. 提取接口返回字段完整（标题/月收入/日均耗时/启动成本），准确率≥85%；<br>2. 向量生成接口返回768维float数组，无格式错误 |
| 管理员基础审核 | 1. 开发简易审核页面（仅管理员可见，需登录验证）；<br>2. 支持“待审核案例列表”展示（含AI提取的基础信息）；<br>3. 实现“通过/驳回”操作（通过后cases表status改为approved） | 1. 非管理员访问审核页返回403；<br>2. 列表展示字段完整（案例标题/数据源/AI提取收益）；<br>3. 操作后cases表status字段同步更新 |

##### 2.2 普通用户角色（最小可用）
| 功能模块       | 具体需求点                                                                 | 验收标准                                                                 |
|----------------|----------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 首页基础展示   | 1. 顶部导航：首页、案例库（仅展示入口，无筛选）；<br>2. 中部：“全球副业案例库”Banner；<br>3. 底部：版权信息、管理员入口（隐藏，仅输入密码可见） | 1. 导航点击无跳转错误；<br>2. Banner图片加载正常（适配移动端）；<br>3. 管理员入口输入正确密码后跳转审核页 |
| 案例列表页     | 1. 展示所有approved状态的案例（默认10条/页，无分页）；<br>2. 案例卡片显示：标题、数据源、月收入、更新时间；<br>3. 未登录用户可查看，点击卡片跳转详情 | 1. 仅展示status=approved的案例，无错误数据；<br>2. 卡片字段无缺失；<br>3. 点击跳转详情页无404 |
| 案例详情页     | 1. 展示案例基础信息（标题/数据源/原帖链接/月收入/日均耗时/启动成本）；<br>2. 未登录用户提示“登录后查看完整步骤”；<br>3. 原帖链接点击跳转数据源平台 | 1. 信息与cases表一致；<br>2. 提示文案清晰，无遮挡；<br>3. 原帖跳转正常，无无效链接 |

#### 3. 非功能需求（V0.1版）
| 类型       | 具体要求                                                                 | 验收标准                                                                 |
|------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 兼容性     | 支持Chrome 90+、Safari 14+（仅桌面端，暂不适配移动端）                   | 2种浏览器打开所有页面，无样式错乱、功能失效                              |
| 安全性     | 1. 密码加密存储（bcrypt算法，cost=10）；<br>2. Deepseek API密钥存储在Vercel环境变量 | 1. 数据库users表password字段显示加密串，无法反解；<br>2. 前端代码无明文API密钥 |
| 可调试性   | 1. 前端控制台打印API请求/响应日志；<br>2. 后端接口返回详细错误信息（如“Deepseek API密钥无效”） | 1. 访问案例列表时，控制台打印“/api/cases/list 请求成功”；<br>2. 密钥错误时返回“code:401, msg:Deepseek API密钥无效” |

### （二）技术设计文档（TDD）
#### 1. 核心技术栈（确认版）
| 层面       | 技术选型                | 版本要求       | 核心作用                  |
|------------|-------------------------|----------------|---------------------------|
| 前端框架   | Next.js                 | 14.0.3         | 页面渲染、路由管理        |
| 认证       | NextAuth.js             | 4.24.5         | 用户登录、会话管理        |
| 数据库     | Neon PostgreSQL         | 15+            | 数据存储（用户/案例/审核）|
| LLM        | Deepseek API            | v1             | 案例提取、向量生成        |
| ORM        | Prisma                  | 5.6.0          | 数据库操作（替代直接SQL） |
| UI样式     | Tailwind CSS            | 3.3.5          | 快速构建页面样式          |
| 邮件服务   | Resend                  | v3             | 发送邮箱验证码            |

#### 2. 数据库设计（Prisma Schema）
```prisma
// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("NEON_DATABASE_URL") // 从环境变量获取Neon连接串
}

// 用户表（适配NextAuth）
model User {
  id                String    @id @default(cuid())
  name              String?
  email             String    @unique
  emailVerified     DateTime?
  password          String?   // 仅邮箱密码登录用户有值（bcrypt加密）
  image             String?   // 头像URL
  preferredLanguage String    @default("en")
  subscribed        Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  accounts          Account[] // 关联第三方登录账号
  sessions          Session[] // 关联会话
  collectedCases    Case[]    @relation("UserCollectedCases") // 后续V0.2用
}

// 第三方登录账号表（NextAuth自动维护）
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// 会话表（NextAuth自动维护）
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 案例表
model Case {
  id                String    @id @default(cuid())
  title             String    // 案例标题
  dataSource        String    // 数据源（Reddit/ProductHunt/IndieHackers）
  originalUrl       String    // 原帖链接
  status            String    // 状态（pending/approved/rejected）
  industry          String?   // 行业（V0.2补充，V0.1暂为NULL）
  monthlyIncome     Int       // 月收入（美元）
  incomeFluctuation Int       // 收入波动范围（美元）
  timeDaily         Float     // 日均耗时（小时）
  launchCost        Int       // 启动成本（美元）
  profitMargin      Int?      // 利润率（%，V0.2补充）
  breakEvenDays     Int?      // 回本周期（天，V0.2补充）
  skillRequirement  String?   // 技能要求（V0.2补充）
  suitableRegion    String?   // 适合地区（V0.2补充）
  steps             Json?     // 实施步骤（JSON，V0.2补充）
  risks             Json?     // 风险与应对（JSON，V0.2补充）
  tools             Json?     // 工具清单（JSON，V0.2补充）
  viewCount         Int       @default(0) // 浏览量
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  collectedBy       User[]    @relation("UserCollectedCases") // 收藏关联
}

// 审核记录表
model Review {
  id        String   @id @default(cuid())
  caseId    String
  reviewerId String   // 审核员ID（关联User.id）
  action    String   // 操作（approve/reject）
  remark    String?  // 审核备注
  createdAt DateTime @default(now())

  case    Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  reviewer User @relation(fields: [reviewerId], references: [id])
}
```

#### 3. 核心接口实现（代码示例）
##### 3.1 Deepseek案例提取接口（Serverless Function）
```javascript
// app/api/ai/extract-case/route.js
import { NextResponse } from 'next/server';

export async function POST(req) {
  try {
    const { rawContent, dataSource, originalUrl } = await req.json();
    const deepseekApiKey = process.env.DEEPSEEK_API_KEY;

    // 1. 构造提示词（明确提取字段）
    const prompt = `
      从以下文本中提取副业案例的关键信息，输出JSON格式，字段包括：
      title（案例标题，简洁）、monthlyIncome（月收入，数字，美元）、
      incomeFluctuation（收入波动范围，数字，美元，无则填0）、
      timeDaily（日均耗时，数字，小时）、launchCost（启动成本，数字，美元）。
      文本：${rawContent}
    `;

    // 2. 调用Deepseek Chat API
    const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${deepseekApiKey}`,
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.2, // 低温度确保结果稳定
        max_tokens: 1000,
      }),
    });

    if (!res.ok) throw new Error(`Deepseek API请求失败: ${res.status}`);
    const data = await res.json();
    const extractedData = JSON.parse(data.choices[0].message.content);

    // 3. 返回提取结果
    return NextResponse.json({
      code: 200,
      data: {
        ...extractedData,
        dataSource,
        originalUrl,
        status: 'pending', // 默认待审核
      },
      msg: '案例提取成功',
    });

  } catch (error) {
    return NextResponse.json({
      code: 500,
      msg: `提取失败: ${error.message}`,
    }, { status: 500 });
  }
}
```

##### 3.2 NextAuth配置（认证核心）
```javascript
// app/api/auth/[...nextauth]/route.js
import NextAuth from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import GoogleProvider from 'next-auth/providers/google';
import bcrypt from 'bcryptjs';
import { PrismaClient } from '@prisma/client';
import { sendVerificationEmail } from '@/lib/resend'; // 自定义Resend工具

const prisma = new PrismaClient();

export const authOptions = {
  providers: [
    // 1. Google OAuth
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }),
    // 2. 邮箱密码登录
    CredentialsProvider({
      name: 'Email Password',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
        verificationCode: { label: 'Verification Code', type: 'text' }, // 可选（未验证用户需填）
      },
      async authorize(credentials) {
        const { email, password, verificationCode } = credentials;
        if (!email || !password) throw new Error('请输入邮箱和密码');

        // 查找用户
        const user = await prisma.user.findUnique({ where: { email } });
        if (!user) {
          // 新用户：创建并发送验证码
          const hashedPassword = await bcrypt.hash(password, 10);
          const newUser = await prisma.user.create({
            data: { email, password: hashedPassword },
          });
          await sendVerificationEmail(email, verificationCode); // 实际项目需生成验证码存储
          throw new Error('请查收邮箱验证码，验证后登录');
        }

        // 已存在用户：验证密码和邮箱
        const passwordMatch = await bcrypt.compare(password, user.password);
        if (!passwordMatch) throw new Error('密码错误');
        if (!user.emailVerified) throw new Error('请先验证邮箱');

        return { id: user.id, email: user.email, name: user.name, image: user.image };
      },
    }),
  ],
  session: {
    strategy: 'jwt', // JWT存储会话
    maxAge: 7 * 24 * 60 * 60, // 7天有效期
  },
  callbacks: {
    // 同步JWT与数据库用户信息
    async jwt({ token, user }) {
      if (user) token.id = user.id;
      return token;
    },
    async session({ session, token }) {
      session.user.id = token.id;
      return session;
    },
  },
  pages: {
    signIn: '/auth/signin', // 自定义登录页
    error: '/auth/error',   // 错误页
  },
  secret: process.env.NEXTAUTH_SECRET,
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };
```

##### 3.3 管理员审核列表接口
```javascript
// app/api/admin/cases/pending/route.js
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { PrismaClient } from '@prisma/client';
import { authOptions } from '../../auth/[...nextauth]/route';

const prisma = new PrismaClient();

// 验证管理员权限（简化版：仅指定邮箱为管理员）
const isAdmin = (email) => {
  const adminEmails = process.env.ADMIN_EMAILS.split(','); // 环境变量：admin1@xxx.com,admin2@xxx.com
  return adminEmails.includes(email);
};

export async function GET() {
  try {
    // 1. 验证登录和管理员权限
    const session = await getServerSession(authOptions);
    if (!session || !isAdmin(session.user.email)) {
      return NextResponse.json({ code: 403, msg: '无管理员权限' }, { status: 403 });
    }

    // 2. 查询待审核案例
    const pendingCases = await prisma.case.findMany({
      where: { status: 'pending' },
      select: {
        id: true,
        title: true,
        dataSource: true,
        monthlyIncome: true,
        timeDaily: true,
        launchCost: true,
        createdAt: true,
      },
      orderBy: { createdAt: 'desc' },
    });

    return NextResponse.json({
      code: 200,
      data: pendingCases,
      msg: '待审核案例获取成功',
    });

  } catch (error) {
    return NextResponse.json({
      code: 500,
      msg: `获取失败: ${error.message}`,
    }, { status: 500 });
  }
}
```

#### 4. 部署配置（V0.1版）
##### 4.1 环境变量（.env.local）
```env
# Next.js基础
NEXT_PUBLIC_APP_URL=https://your-vercel-app.vercel.app
NEXTAUTH_URL=https://your-vercel-app.vercel.app
NEXTAUTH_SECRET=your-nextauth-secret-32byte-hex # 用openssl rand -hex 32生成

# Neon PostgreSQL
NEON_DATABASE_URL=postgresql://user:password@ep-xxx.us-east-2.aws.neon.tech/dbname?sslmode=require
NEON_DATABASE_URL_READ=postgresql://user:password@ep-xxx-ro.us-east-2.aws.neon.tech/dbname?sslmode=require

# Deepseek API
DEEPSEEK_API_KEY=sk-your-deepseek-api-key

# Google OAuth
GOOGLE_CLIENT_ID=123456789-xxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxx

# Resend（邮箱验证码）
RESEND_API_KEY=re-your-resend-api-key
ADMIN_EMAILS=admin@richidea.club # 管理员邮箱
```

##### 4.2 部署步骤（Vercel）
1. 本地初始化：
   ```bash
   # 1. 创建Next.js项目
   npx create-next-app@latest richidea-cases --typescript --tailwind --app
   cd richidea-cases

   # 2. 安装依赖
   npm install @prisma/client next-auth bcryptjs @next-auth/credentials @next-auth/google resend
   npm install -D prisma typescript @types/node @types/react

   # 3. 初始化Prisma并推送Neon
   npx prisma init
   # 编辑schema.prisma（见上文）后推送
   npx prisma db push

   # 4. 本地启动
   npm run dev
   ```
2. Vercel部署：
   - 关联GitHub仓库（richidea-cases）；
   - 在Vercel项目设置→Environment Variables中添加上述.env.local变量；
   - 部署分支选择`dev`（V0.1开发分支），触发自动部署。


## 二、V0.2（测试版）：基础功能补全与优化
### （一）功能需求文档（FRD）
#### 1. 核心目标
补全「案例筛选搜索+用户收藏+性能优化」，输出可测试的功能版本，验证用户核心体验。

#### 2. 功能模块（基于V0.1迭代）
##### 2.1 普通用户角色（核心体验）
| 功能模块       | 具体需求点                                                                 | 验收标准                                                                 |
|----------------|----------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 案例筛选功能   | 1. 筛选面板（左侧固定，移动端可折叠）：<br> - 收益范围：$1k-$3k/$3k-$5k/$5k+<br> - 时间投入：<1h/1-3h/3+h<br> - 启动成本：$0/$1-$50/$50-$200/$200+<br>2. 筛选逻辑：多条件组合，实时更新结果（无页面刷新） | 1. 筛选面板在桌面端/移动端显示正常；<br>2. 选择“$3k-$5k+<1h+$0-$50”返回正确案例；<br>3. 筛选结果加载时间≤500ms |
| 语义搜索功能   | 1. 顶部搜索框：支持自然语言查询（如“零基础被动收入副业”）；<br>2. 搜索提示：显示热门查询（“$5k+被动收入”“电商副业”）；<br>3. 无结果时提示“无匹配案例，尝试其他关键词” | 1. 输入“零基础+月入3k”返回匹配案例（如Etsy数字产品）；<br>2. 热门提示点击可直接搜索；<br>3. 无结果提示文案清晰 |
| 用户收藏功能   | 1. 案例卡片/详情页显示“收藏”按钮（未登录提示登录）；<br>2. 登录用户点击收藏：按钮变色，同步到“我的收藏”（新增页面）；<br>3. 收藏页：展示所有收藏案例，支持取消收藏 | 1. 未登录点击收藏弹出登录弹窗；<br>2. 收藏后按钮从“空心”变“实心”；<br>3. 收藏页案例与数据库collectedCases关联一致 |
| 案例详情补充   | 1. 补充字段：利润率、回本周期、技能要求（零基础/基础/专业）、适合地区；<br>2. 显示“用户浏览量”；<br>3. 底部添加“相关案例”（2个，按行业匹配） | 1. 字段与cases表补充数据一致；<br>2. 浏览量每访问1次+1（去重，同一用户24h内仅算1次）；<br>3. 相关案例与当前案例行业匹配度≥80% |

##### 2.2 开发/测试角色（优化与验证）
| 功能模块       | 具体需求点                                                                 | 验收标准                                                                 |
|----------------|----------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 数据库优化     | 1. 为cases表添加索引：<br> - 筛选索引：idx_cases_income_time (monthlyIncome, timeDaily)<br> - 搜索索引：idx_cases_title (title)（GIN索引，支持模糊查询）<br>2. 配置Neon查询缓存（缓存有效期10分钟） | 1. 索引创建成功（通过Neon Console查看）；<br>2. 重复筛选同一条件，第二次查询时间≤100ms（缓存生效） |
| 前端性能优化   | 1. 案例列表页用ISR（增量静态再生）：revalidate=3600（1小时更新）；<br>2. 案例图片用Next.js Image组件（懒加载+压缩）；<br>3. 代码分割：筛选组件动态导入（仅在案例库页加载） | 1. 列表页首次加载后，1小时内刷新用缓存，超时自动更新；<br>2. 图片加载速度≤300ms，无变形；<br>3. 首页JS体积减少≥20% |
| 测试数据补充   | 1. 人工补全20个approved案例（含完整字段：steps/risks/tools）；<br>2. 模拟10个测试用户（含管理员/普通用户）；<br>3. 每个测试用户收藏3-5个案例 | 1. 案例数据完整率100%（无NULL字段）；<br>2. 测试用户可正常登录使用所有功能；<br>3. 收藏数据覆盖不同行业案例 |

#### 3. 非功能需求（V0.2版）
| 类型       | 具体要求                                                                 | 验收标准                                                                 |
|------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 性能       | 1. 首页加载时间≤2s；<br>2. 案例列表/详情页加载时间≤1.5s；<br>3. 筛选/搜索响应时间≤500ms | 用Google PageSpeed测试，首页得分≥85；<br>2. 浏览器Network面板查看加载时间；<br>3. 接口响应时间日志≤500ms |
| 兼容性     | 1. 适配移动端（iPhone 12+/安卓旗舰机，分辨率≥1080×1920）；<br>2. 支持Firefox 88+、Edge 90+ | 1. 移动端无横向滚动条，按钮点击区域≥44×44px；<br>2. 新增浏览器打开无功能失效 |
| 可测试性   | 1. 所有接口返回详细错误码（如400=参数错误，401=未登录）；<br>2. 前端添加“测试模式”（URL参数?test=1，显示接口请求日志） | 1. 调用无参数接口返回“code:400, msg:缺少参数”；<br>2. 测试模式下控制台打印完整请求/响应 |

### （二）技术设计文档（TDD）
#### 1. 数据库优化（索引与缓存）
##### 1.1 新增索引（SQL脚本）
```sql
-- 1. 案例筛选索引（收益+时间）
CREATE INDEX idx_cases_income_time ON "Case" (monthlyIncome, timeDaily) GLOBAL;

-- 2. 案例标题搜索索引（GIN索引，支持模糊查询）
CREATE INDEX idx_cases_title_gin ON "Case" USING GIN (to_tsvector('english', title));

-- 3. 浏览量排序索引
CREATE INDEX idx_cases_view_count ON "Case" (viewCount DESC) GLOBAL;
```

##### 1.2 Neon缓存配置（SQL）
```sql
-- 为案例列表查询添加缓存（有效期10分钟）
SET LOCAL neon.query_cache_ttl = 600; -- 单位：秒
```

#### 2. 核心功能实现（代码示例）
##### 2.1 案例筛选+搜索接口
```javascript
// app/api/cases/list/route.js
import { NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';
import { generateEmbedding } from '@/lib/deepseek-embedding'; // 自定义Deepseek向量工具

const prisma = new PrismaClient();

export async function GET(req) {
  try {
    const { searchParams } = new URL(req.url);
    // 1. 获取筛选参数
    const incomeRange = searchParams.get('incomeRange'); // 如"3k-5k"
    const timeDaily = searchParams.get('timeDaily');     // 如"<1h"
    const costRange = searchParams.get('costRange');     // 如"0-50"
    const searchQuery = searchParams.get('q');           // 搜索关键词

    // 2. 构建筛选条件
    const where = { status: 'approved' };
    // 收益范围
    if (incomeRange) {
      const [min, max] = incomeRange.split('-').map(v => v === '5k+' ? 5000 : parseInt(v) * 1000);
      where.monthlyIncome = max ? { gte: min, lte: max } : { gte: min };
    }
    // 时间投入
    if (timeDaily) {
      const [max] = timeDaily.split('h').map(v => parseInt(v));
      where.timeDaily = { lte: max };
    }
    // 启动成本
    if (costRange) {
      const [min, max] = costRange.split('-').map(v => parseInt(v));
      where.launchCost = max ? { gte: min, lte: max } : { gte: min };
    }
    // 搜索关键词（优先语义搜索，无则模糊查询）
    if (searchQuery) {
      try {
        // 语义搜索：生成向量并匹配（简化版，实际需存储案例向量）
        const queryEmbedding = await generateEmbedding(searchQuery);
        // 此处省略向量匹配逻辑，暂用标题模糊查询替代
        where.title = { contains: searchQuery, mode: 'insensitive' };
      } catch (error) {
        // 向量生成失败，降级为标题模糊查询
        where.title = { contains: searchQuery, mode: 'insensitive' };
      }
    }

    // 3. 查询案例（带分页）
    const page = parseInt(searchParams.get('page')) || 1;
    const pageSize = parseInt(searchParams.get('pageSize')) || 10;
    const skip = (page - 1) * pageSize;

    const [cases, total] = await Promise.all([
      prisma.case.findMany({
        where,
        select: {
          id: true, title: true, dataSource: true, monthlyIncome: true,
          timeDaily: true, launchCost: true, viewCount: true, updatedAt: true,
        },
        skip, take: pageSize, orderBy: { viewCount: 'desc' },
      }),
      prisma.case.count({ where }),
    ]);

    return NextResponse.json({
      code: 200,
      data: { list: cases, total, page, pageSize },
      msg: '案例列表获取成功',
    });

  } catch (error) {
    return NextResponse.json({
      code: 500,
      msg: `获取失败: ${error.message}`,
    }, { status: 500 });
  }
}
```

##### 2.2 用户收藏功能（接口+组件）
```javascript
// 1. 收藏/取消收藏接口（app/api/cases/collect/route.js）
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { PrismaClient } from '@prisma/client';
import { authOptions } from '../../auth/[...nextauth]/route';

const prisma = new PrismaClient();

export async function POST(req) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) return NextResponse.json({ code: 401, msg: '请先登录' }, { status: 401 });

    const { caseId, isCollect } = await req.json();
    const userId = session.user.id;

    if (isCollect) {
      // 收藏：关联用户与案例
      await prisma.user.update({
        where: { id: userId },
        data: {
          collectedCases: { connect: { id: caseId } },
        },
      });
    } else {
      // 取消收藏：解除关联
      await prisma.user.update({
        where: { id: userId },
        data: {
          collectedCases: { disconnect: { id: caseId } },
        },
      });
    }

    return NextResponse.json({ code: 200, msg: isCollect ? '收藏成功' : '取消收藏成功' });

  } catch (error) {
    return NextResponse.json({
      code: 500,
      msg: `操作失败: ${error.message}`,
    }, { status: 500 });
  }
}

// 2. 收藏按钮组件（components/CaseCollectButton.jsx）
'use client';
import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import axios from 'axios';

export default function CaseCollectButton({ caseId }) {
  const [isCollect, setIsCollect] = useState(false);
  const { data: session } = useSession();
  const router = useRouter();

  // 初始化：查询用户是否已收藏
  useEffect(() => {
    if (!session) return;
    const fetchCollectStatus = async () => {
      const res = await axios.get(`/api/users/collections`); // 需实现“我的收藏”接口
      const collectedCaseIds = res.data.data.map(c => c.id);
      setIsCollect(collectedCaseIds.includes(caseId));
    };
    fetchCollectStatus();
  }, [session, caseId]);

  // 点击收藏/取消
  const handleCollect = async () => {
    if (!session) {
      router.push('/auth/signin?callbackUrl=/cases/detail/${caseId}');
      return;
    }

    await axios.post('/api/cases/collect', { caseId, isCollect: !isCollect });
    setIsCollect(!isCollect);
  };

  return (
    <button 
      onClick={handleCollect}
      className={`p-2 rounded-full ${isCollect ? 'bg-red-100 text-red-500' : 'bg-gray-100 text-gray-500'}`}
    >
      {/* 收藏图标：空心/实心 */}
      {isCollect ? (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
        </svg>
      ) : (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
      )}
    </button>
  );
}
```

##### 2.3 前端性能优化（ISR+Image）
```javascript
// 1. 案例列表页ISR配置（app/cases/page.js）
export const revalidate = 3600; // 1小时增量更新

export default async function CasesPage() {
  // 服务端获取初始数据（ISR预渲染）
  const res = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/cases/list?page=1&pageSize=10`, {
    next: { revalidate: 3600 }, // 与页面revalidate一致
  });
  const { data } = await res.json();
  const initialCases = data.list;

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">全球副业案例库</h1>
      {/* 筛选面板（动态导入，减少初始JS体积） */}
      const FilterPanel = dynamic(() => import('@/components/FilterPanel'), {
        loading: () => <div>加载筛选面板...</div>,
        ssr: false, // 客户端渲染，避免服务端无窗口对象错误
      });
      <FilterPanel />
      {/* 案例列表 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
        {initialCases.map(caseItem => (
          <CaseCard key={caseItem.id} case={caseItem} />
        ))}
      </div>
    </div>
  );
}

// 2. 案例图片组件（components/CaseImage.jsx）
import Image from 'next/image';

export default function CaseImage({ src, alt }) {
  return (
    <div className="relative w-full h-48 rounded-lg overflow-hidden">
      {/* Next.js Image自动优化：懒加载、压缩、适配尺寸 */}
      <Image
        src={src || '/default-case.jpg'} // 默认图片
        alt={alt || '案例图片'}
        fill
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
        className="object-cover"
        loading="lazy" // 懒加载
        priority={false} // 非首屏图片不优先加载
      />
    </div>
  );
}
```

#### 3. 测试数据准备（SQL脚本）
```sql
-- 1. 补全20个approved案例（示例1个，其余类似）
INSERT INTO "Case" (
  title, dataSource, originalUrl, status, industry, 
  monthlyIncome, incomeFluctuation, timeDaily, launchCost,
  profitMargin, breakEvenDays, skillRequirement, suitableRegion,
  steps, risks, tools
) VALUES (
  'Etsy数字产品销售（月入$4k）',
  'IndieHackers',
  'https://indiehackers.com/post/etsy-digital-products-4k-month',
  'approved',
  '电商',
  4000,
  500,
  1.5,
  50,
  80,
  15,
  '基础设计',
  '全球通用',
  '[{"step":1,"title":"设计数字产品（如 planners）","content":"用Canva设计，尺寸A4，分辨率300dpi","isFree":false,"imageUrl":"https://cloudinary.com/.../canva-design.png"}]',
  '[{"risk":"平台审核不通过","solution":"避免侵权元素，提交前检查Etsy规则"}]',
  '[{"name":"Canva","type":"free","price":0,"desc":"设计工具","affiliateUrl":"https://canva.com/?via=richidea"}]'
);

-- 2. 创建测试用户（管理员+普通用户）
-- 管理员用户（密码：Admin123!，bcrypt加密）
INSERT INTO "User" (
  name, email, emailVerified, password, image, preferredLanguage, subscribed
) VALUES (
  'Admin User',
  'admin@richidea.club',
  NOW(),
  '$2a$10$xxx...', -- 替换为bcrypt加密后的密码
  'https://avatar.example.com/admin.jpg',
  'en',
  true
);

-- 普通用户（密码：User123!）
INSERT INTO "User" (
  name, email, emailVerified, password, image, preferredLanguage, subscribed
) VALUES (
  'Test User 1',
  'user1@example.com',
  NOW(),
  '$2a$10$xxx...', -- 替换为bcrypt加密后的密码
  'https://avatar.example.com/user1.jpg',
  'zh',
  false
);

-- 3. 测试用户收藏案例
INSERT INTO "_UserCollectedCases" ("A", "B") VALUES (
  (SELECT id FROM "User" WHERE email = 'user1@example.com'),
  (SELECT id FROM "Case" WHERE title = 'Etsy数字产品销售（月入$4k）')
);
```

#### 4. 部署与测试（V0.2版）
##### 4.1 部署步骤
1. 本地合并V0.1代码到`dev`分支，提交V0.2新增代码；
2. 在Vercel项目中，将“预览环境”分支切换为`dev`，触发自动部署；
3. 部署完成后，执行Prisma迁移（补全表字段+索引）：
   ```bash
   npx prisma db push
   ```
4. 执行测试数据SQL脚本（通过Neon Console的SQL Editor）。

##### 4.2 测试清单（V0.2版）
| 测试项               | 测试步骤                                                                 | 预期结果                                                                 |
|----------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 筛选功能             | 1. 访问案例库页；2. 选择“$3k-$5k”+“<1h”+“$0-$50”；3. 查看结果              | 结果包含“Etsy数字产品”等符合条件的案例，无无关案例                        |
| 搜索功能             | 1. 搜索框输入“零基础 被动收入”；2. 点击搜索                                | 结果包含“在线课程（月入$7k）”等案例，无结果时显示提示                    |
| 收藏功能             | 1. 登录test user1；2. 收藏“Etsy数字产品”案例；3. 进入“我的收藏”页          | 收藏按钮变色，收藏页显示该案例，点击取消收藏后移除                        |
| 性能优化             | 1. 用Google PageSpeed测试首页；2. 查看案例列表页加载时间                  | 首页得分≥85，列表页加载时间≤1.5s，图片懒加载生效                        |
| 管理员审核           | 1. 登录admin用户；2. 提交1个待审核案例；3. 执行“通过”操作                  | 案例status改为approved，前端案例库页显示该案例                            |


## 三、交付物清单（V0.1+V0.2版）
| 版本   | 交付物类型               | 具体内容                                                                 |
|--------|--------------------------|--------------------------------------------------------------------------|
| V0.1   | 代码仓库                 | GitHub仓库（含Next.js项目、Prisma Schema、核心接口代码）                  |
| V0.1   | 数据库文档               | Neon PostgreSQL连接指南、表结构说明、初始数据脚本                        |
| V0.1   | 部署文档                 | Vercel部署步骤、环境变量配置表、本地开发指南                              |
| V0.1   | 测试报告                 | NextAuth登录测试、Deepseek API连通性测试、管理员审核功能测试报告          |
| V0.2   | 代码增量                 | V0.2新增代码（筛选/搜索/收藏组件、性能优化代码）                          |
| V0.2   | 优化文档                 | 数据库索引优化报告、前端性能优化报告（PageSpeed得分）                     |
| V0.2   | 测试数据                 | 20个完整案例数据SQL脚本、10个测试用户数据脚本                             |
| V0.2   | 用户手册（测试版）       | 普通用户使用指南（筛选/搜索/收藏）、管理员审核指南                        |